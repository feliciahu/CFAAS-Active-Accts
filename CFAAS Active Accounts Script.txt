SHOW TASKS LIKE 'TSK_FELICIA_H_CFAAS_ACTIVE_ACCTS%';
DESC TASK TSK_FELICIA_H_CFAAS_ACTIVE_ACCTS;
execute task TSK_FELICIA_H_CFAAS_ACTIVE_ACCTS;

select *  from table(SBX_PSAS_DB.INFORMATION_SCHEMA.task_history(
scheduled_time_range_start=>dateadd('day',-7,current_timestamp()),
result_limit => 10,
task_name=>'TSK_FELICIA_H_CFAAS_ACTIVE_ACCTS'));
    
alter task TSK_FELICIA_H_CFAAS_ACTIVE_ACCTS resume; --It was by default suspended  ( run this command Only first time since by default its suspended)


--TASK
CREATE OR REPLACE TASK TSK_FELICIA_H_CFAAS_ACTIVE_ACCTS
WAREHOUSE = SBX_EA_GENERAL_FR_WH
SCHEDULE = 'USING CRON 50 6 * * 1-5 America/Chicago' -- 6:50 AM on weekdays
TIMESTAMP_INPUT_FORMAT = 'YYYY-MM-DD HH24'
AS

CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.T_CFAAS_ACTIVE_ACCTS AS
WITH 
ACCT AS (

SELECT
  CID.CUST_ACCT_ID,
  AC.CUSTOMER_STATUS,
  AC.FIRST_SALE_DATE,
  AC.LAST_SALE_DATE
FROM
 
/* DISTICNT LIST OF CFAAS ACCOUNTS WITH SALES*/
 
  (SELECT
    DISTINCT SUBSTRING(CFS.CUST_SALES, 5, 6) AS CUST_ACCT_ID
  FROM
    PRD_ENT_PL_DATALAKE_DB.CFAAS.V_ACRSDSH100 CFS
  WHERE
    CFS.PLANT IN ('8934') 
    AND BILL_QTY <> 0 
  ) AS CID
 
LEFT JOIN
 
/* CURRENT ACTIVE SALES STATUS */
 
(SELECT      
  SUBSTRING(CFS.CUST_SALES, 5, 6) AS CUST_ACCT_ID,
  MAX(CAST(SUBSTRING(CFS.CALDAY, 5, 2) || '/' || SUBSTRING(CFS.CALDAY, 7, 2) || '/' || SUBSTRING(CFS.CALDAY, 1, 4) AS DATE)) AS LAST_SALE_DATE,
  MIN(CAST(SUBSTR(CFS.CALDAY,5,2) || '/' || SUBSTR(CFS.CALDAY,7,2) || '/' || SUBSTR(CFS.CALDAY,1,4) AS DATE)) AS FIRST_SALE_DATE,
  (CASE 
    WHEN MAX(CAST(SUBSTRING(CFS.CALDAY, 5, 2) || '/' || SUBSTRING(CFS.CALDAY, 7, 2) || '/' || SUBSTRING(CFS.CALDAY, 1, 4) AS DATE)) >= DATEADD(day, -7, CURRENT_DATE) THEN 'Active'
    WHEN MAX(CAST(SUBSTRING(CFS.CALDAY, 5, 2) || '/' || SUBSTRING(CFS.CALDAY, 7, 2) || '/' || SUBSTRING(CFS.CALDAY, 1, 4) AS DATE)) < DATEADD(day, -7, CURRENT_DATE) THEN 'Inactive'
  END) AS CUSTOMER_STATUS
FROM        
  PRD_ENT_PL_DATALAKE_DB.CFAAS.V_ACRSDSH100 CFS
WHERE       
  CFS.PLANT IN ('8934') 
  AND BILL_QTY <> 0
GROUP BY
  SUBSTRING(CFS.CUST_SALES, 5, 6)
 
) AS AC ON AC.CUST_ACCT_ID = CID.CUST_ACCT_ID
)

SELECT * FROM ACCT

-- SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.T_CFAAS_ACTIVE_ACCTS;
